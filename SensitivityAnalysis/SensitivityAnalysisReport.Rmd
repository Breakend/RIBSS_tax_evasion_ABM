---
title: "Sensitivity Analysis of IBSS Tax Model"
output:
  rmarkdown::pdf_document:
    fig_caption: yes        
    includes:  
      in_header: Writeup/preamble-header.tex
---

#Introduction
This document presents the sensitivity analysis of the IBSS tax model. The data for the analysis was generated by running the  Tax Model over 96 distinct model options and 100 cases of varying inputs (sampled using the Latim Hypercube Sampling method) for each model and 10 randomized realizations of each case, equalling a total of 96,000 runs of the model. The data generated by those runs is used to analyze the sensitivity of the model to various inputs.

```{r Initializations, include=FALSE}
rm(list=ls())
### Load Libraries: please ensure you have installed these R packages.
library(ggplot2)
library(Hmisc)
library(igraph)
library(reshape2)
library(sdtoolkit)
library(rpart) #for CART routines: rpart = recursive partitioning and regression trees
library(rpart.plot)
library(randomForest)
library(plyr)
library(scales)
library(ggExtra)
library(corrgram)
library(stringr)

#Setting options
#Setting options
options(warn=1)
options(showErrorCalls=TRUE)
options(showWarnCalls=TRUE)
source("Library/library.R")


average.over.realizations<-function(xdat,input.fields,output.fields){
  
  x<- xdat[1,input.fields]
  y <- apply(xdat[,output.fields],2,mean,na.rm = T)
  
  return(unlist(c(x,y)))
}

```

```{r Massage Data, include=FALSE}
dat <- read.csv("Outputs/sensitivity_analysis_data.csv")

### convert network.model to logical
tmp <- !(dat$network.model%in%FALSE)
dat$network.model <- tmp

ll<-match("seed",colnames(dat))
input.fields <- colnames(dat)[1:ll]
output.fields<- colnames(dat)[!(colnames(dat)%in%input.fields)]
input.fields<- input.fields[!(input.fields%in%"seed")]

dat.split <- split(dat, list(dat$model.option,dat$case))

dat.split.tmp <- lapply(dat.split,FUN=average.over.realizations,
                        input.fields=input.fields,
                        output.fields=output.fields)
dat.realization.avg<- as.data.frame(do.call("rbind",dat.split.tmp))

ll<-match("total.years",colnames(dat.realization.avg))
input.fields <- colnames(dat.realization.avg)[1:ll]
output.fields<- colnames(dat.realization.avg)[!(colnames(dat.realization.avg)%in%input.fields)]

dat.split <- split(dat.realization.avg,dat.realization.avg$model.option)
dat.split.tmp <- lapply(dat.split,FUN=average.over.realizations,
                        input.fields=input.fields,
                        output.fields=output.fields)
dat.case.avg<- as.data.frame(do.call("rbind",dat.split.tmp))

model.option.fields <- input.fields[3:9]

mo.names <- NULL
mo.names["network.model"] <- "Network Effect"
mo.names["mild.tendency.to.full.evasion"] <- "Mild Tendency to Full Evasion"
mo.names["tax.refund.effect"] <- "Tax Refund Effect"
mo.names["targetted.auditing"] <- "Targetted Auditing"
mo.names["bomb.crater.effect"] <- "Bomb Crater Effect"
mo.names["gamblers.fallacy"] <- "Gambler's Fallacy"
mo.names["media.effect"] <- "Media Effect"
```


#Sensitivity to Model Options
In oder to perform this sensitivity analysis we use Classification and Regression Trees (CART) -- a recursive partitioning method used in data mining. Classification trees are used for categorical data and regression trees are used for continuous data. 

## Tax gap
From the figure below, it appears that the tax gap is most sensitive to the mild tendency of agents to fully evade their income. Following it are the tax refund effect, social network effect and targetted auditing to which tax gap is sensitive. Gambler's fallacy, bomb crater effect and media effect have the least effect on tax gap in the model. These behaviors are in line with prior expectations. 
```{r Analysing the Sensitivity of Tax Gap, include=FALSE}
### Run CART Model
formula<- paste("tax.gap.percent","~",paste(model.option.fields,collapse="+"),sep="")
formula <-eval(parse(text=formula))
CART.fit <- rpart(formula, dat.case.avg, method="anova") ## , method="class" didn't work well: histograms seemed wrong.

### Do Random Forest Sensitivity Analysis
RF.fit <- randomForest(formula,data = dat.case.avg,importance = TRUE)

### Arrange the Sensitivity Analysis table 
sensi.dat <- get.sensitivity.table(CART.fit,RF.fit)
prp(CART.fit)
```
```{r CartPlot, include=FALSE, fig.cap="CART Plot"}
### Plot CART tree
rpart.plot(CART.fit)
```
```{r TG_Plot, echo=FALSE, fig.cap="Sensitivity of tax gap with various model options"}
ggplot()+
  geom_bar(data= sensi.dat,aes(x=option,y=IncNodePurity),stat="identity", fill="cornflowerblue", color="black") +
  theme_bw() +
  ylab(str_wrap("Normalized Score (IncNodePurity)", 17))+ xlab("Model Options")+
  ggtitle(paste("Sensitivity of Tax gap",sep="")) +
  scale_x_discrete(labels = str_wrap(mo.names[row.names(sensi.dat)], width = 11))
```

## Perceived Audit Rate
From the figure below, it appears that perceived audit rate of agents in the model is highly sensitive to mild tendency to evade full income, targetting auditing and tax refund effects. Interestingly, sensitivity of perceived audit rate with gambler's fallacy is more important than that of bomb crater effect. Social network and media effects do not produce much variation in perceived audit rate. All these behaviors are as expected by us.
```{r PAR, include=FALSE}
formula<- paste("mean.per.audit.rate","~",paste(model.option.fields,collapse="+"),sep="")
formula <-eval(parse(text=formula))
CART.fit <- rpart(formula, dat.case.avg, method="anova")
RF.fit <- randomForest(formula,data = dat.case.avg,importance = TRUE)
sensi.dat <- get.sensitivity.table(CART.fit,RF.fit)
prp(CART.fit)
rpart.plot(CART.fit)
```
```{r PAR_Plot, echo=FALSE, fig.cap="Sensitivity of tax gap with various model options"}
ggplot()+
  geom_bar(data= sensi.dat,aes(x=option,y=IncNodePurity),stat="identity", fill="cornflowerblue", color="black") +
  theme_bw() +
  ylab(str_wrap("Normalized Score (IncNodePurity)", 17))+ xlab("Model Options")+
  ggtitle(paste("Sensitivity of Perceived Audit Rate",sep="")) +
  scale_x_discrete(labels = str_wrap(mo.names[row.names(sensi.dat)], width = 11))
```

```{r SensiDatMelt, include=FALSE}
sensi.dat.melt <-melt(sensi.dat, id="option" ,value.name = "importance")
sensi.dat.melt <- sensi.dat.melt[!is.na(sensi.dat.melt[,"importance"]),]

```




